name: CI/CD Pipeline for OurShelves

on: 
  push:
    branches: [ feat/ci-cd ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Start the DB
        run: docker compose up -d db

      - name: Wait for database to be setup
        run: |
          echo "Waiting for MySQL to be ready..."
          timeout 60 bash -c 'until docker compose exec -T db mysqladmin ping -h localhost -pRootpassword --silent; do sleep 2; done'

      - name: Run backend unit tests within docker container
        run: docker compose run --rm api sh -c "npm test"

  backend-integration-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Run backend integration tests within docker container
      # mount the docker socket to allow the test container to interact with the host docker daemon
      # alternative is to add volume mount to docker-compose.yml
        run: docker compose run --rm -v /var/run/docker.sock:/var/run/docker.sock api sh -c "npm run test:integration"


  frontend-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Run frontend tests within container
        run: docker compose run --rm frontend sh -c "npm run test"


  e2e-tests:
    runs-on: ubuntu-latest
    needs: [backend-tests, backend-integration-tests, frontend-tests]

    steps:
      - uses: actions/checkout@v3

      - name: Wait for all services to be ready and built
        run: docker compose up -d

      - name: Wait for services to be ready
        run: |
          echo "Waiting for backend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:3000/; do sleep 2; done'
          echo "Waiting for frontend to be ready..."
          timeout 60 bash -c 'until curl -f http://localhost:5173; do sleep 2; done'

      - name: Run E2E tests
        run: docker compose run --rm -e CYPRESS_baseUrl=http://localhost:5173 frontend npx cypress run

      - name: Stop services
        if: always()
        run: docker compose down